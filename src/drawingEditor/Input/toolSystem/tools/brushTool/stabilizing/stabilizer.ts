import { type BrushPoint } from '../brushTool';
import { assert } from '~/util/general/contracts';
import { type BaseBrushSettings } from '../../../settings/brushSettings';

////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////
//! TYPE DEFINITIONS
////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////

type StabilizerType = 'nothing' | 'spring' | 'box' | 'movingAverage' | 'exponentialMovingAverage';

////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////
//! MAIN CLASS
////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////

export abstract class Stabilizer {
  private stabilizerType: StabilizerType;

  constructor(stabilizerType: StabilizerType) {
    this.stabilizerType = stabilizerType;
  }

  public abstract addPoint(point: BrushPoint, brushSettings: BaseBrushSettings): void;
  public abstract getProcessedCurve(brushSettings: BaseBrushSettings): BrushPoint[];
  public abstract reset(): void;

  // Optiona override.
  // eslint-disable-next-line @typescript-eslint/no-unused-vars
  public update(deltaTime: number, brushSettings: BaseBrushSettings) {
    return;
  }

  public isOfType(stabilizerType: StabilizerType): boolean {
    return this.stabilizerType == stabilizerType;
  }

  public isBatchedStabilizer(): this is BatchedStabilizer {
    return this instanceof BatchedStabilizer;
  }

  public assertIsBatched(): asserts this is BatchedStabilizer {
    assert(this.isBatchedStabilizer());
  }

  public isIncrementalStabilizer(): this is IncrementalStabilizer {
    return this instanceof IncrementalStabilizer;
  }

  public assertIsIncremental(): asserts this is IncrementalStabilizer {
    assert(this.isIncrementalStabilizer());
  }
}

////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////
//! SUB CLASSES
////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////

export abstract class BatchedStabilizer extends Stabilizer {
  constructor(stabilizerType: StabilizerType) {
    super(stabilizerType);
  }

  abstract predictSizeOfOutput(): number;
  abstract partitionStroke(brushSettings: BaseBrushSettings, maxSizeStroke: number): BrushPoint[];
}

export abstract class IncrementalStabilizer extends Stabilizer {
  constructor(stabilizerType: StabilizerType) {
    super(stabilizerType);
  }
}

////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////
//! EXPORTED HELPERS
////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////
